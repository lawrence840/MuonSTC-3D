# ⚛️ 3D Density Reconstruction for Muography Simulation

This repository contains a Python-based framework for performing 3D density reconstruction from muography projection data. The workflow is designed to be modular, allowing users to configure the geometry, select from various reconstruction algorithms, and evaluate the final results using established quality metrics.

---

## Getting Started

### Prerequisites

* **Python 3.8+**
* **Pip**

### Installation

1. Clone the repository:

   ```sh
   git clone [https://github.com/lawrence840/MuonSTC-3D.git](https://github.com/lawrence840/MuonSTC-3D.git)
   cd MuonSTC-3D
   ```

2. Install the required packages:

   ```sh
   pip install -r requirements.txt
   ```

---

## ❗ Important: User-Supplied Data

### Opacity Matrix Calculation

Before running the main reconstruction, you must provide an opacity matrix (muon transmittance data). This file is not included in the repository and must be generated by you.

* **Action:** Run a simulation in **Geant4** to calculate the muon opacity for your specific model and detector geometry.
* **Output File:** Save the resulting matrix as `selected_opacity_matrix.txt`.
* **Location:** Place this file inside the `data/` directory.

**Tip:** For symmetrical models, you may only need to simulate one detector view and then replicate the data accordingly to generate the full matrix.

---

## ⚙️ Step-by-Step Workflow

The process is divided into three main steps, each handled by a dedicated script.

### 1. Generate the Path Length Matrix

First, you must compute the path length matrix (`L`), which describes the path of each muon through the volume of interest. This is a one-time, potentially lengthy calculation for each voxel resolution.

* **Script:** `scripts/calculate_paths.py`
* **Action:** Edit this script to define your custom **Region of Interest (ROI)** and `detectors` setup. Run the script for each desired resolution (e.g., 1.0m, 0.5m).
* **Output:** This creates `path_lengths_matrix_*.npz` files. Move these files into the `data/` folder.

### 2. Perform 3D Reconstruction

Once the path length matrices are in the `data/` folder, you can run the reconstruction using one or more of the available iterative algorithms.

* **Script:** `main.py`
* **Action:** Edit the script to select which reconstruction methods you want to run (e.g., SART, EM, L-BFGS, TR). You can also adjust hyperparameters in `config.py`.
* **Output:** Reconstructed 3D images and data slices are saved to the `results/` directory, organized by algorithm and voxel size.

### 3. Evaluate Reconstruction Quality

Finally, you can evaluate the quality of the reconstruction against a ground truth model using quantitative metrics.

* **Script:** `analysis/metrics.py`
* **Action:** Provide the ground truth density distribution model and define the specific regions within the model for comparison.
* **Output:** This script calculates the **Kappa coefficient** and **Gradient Clarity factor**, providing quantitative metrics that characterize the quality of the reconstruction.

---

## 📜 Citation

If you use or refer to this code, please cite the following paper:

> **\*He, Z. Y., Pan, Z. W., Yao, Z. H., et al. (2025). A simulation comparison of 3D reconstruction techniques of muography for blast furnace. *Journal of Applied Physics*, 138(6).***
>
> *[Link to the paper](https://doi.org/10.1063/5.0280295)*

---

## License

This project is licensed under the **MIT License**. See the `LICENSE` file for details.
